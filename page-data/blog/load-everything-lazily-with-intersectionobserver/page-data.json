{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/load-everything-lazily-with-intersectionobserver/","webpackCompilationHash":"8eb1eef152d1ee0ad370","result":{"data":{"post":{"frontmatter":{"title":"Load everything lazily with IntersectionObserver","date":"2019-01-23T21:52:08.746Z","tags":["reactjs","react-hooks","web-api"]},"html":"<p>Just after I've released <a href=\"https://www.nikitakirsanov.com/changelog/\">1.8</a> version of site and published post <a href=\"https://www.nikitakirsanov.com/blog/implementing-medium-like-tooltip/\">Implementing medium like tooltip</a>, I had understood its page loads 6 mb! And it is absolutely inappropriate for my blazing fast site. The most significant change of this release was integration with <a href=\"https://codesandbox.io\">codesandbox</a>: all embedded links to it are transformed to iframes. Results I've got in <em>network</em> tab of chrome dev tools also had met my expectations: most of resources were loaded by iframes.</p>\n<p>Obvious solution is to load iframes lazily - when they appear in the viewport. So here is a code I came up with:</p>\n<p>First of all rename src attribute of iframe to something else (e.g. data-src), so it won't load anything during initial render.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>iframe</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token attr-name\">data-src</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>https://nikitakirsanov.com<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>iframe</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>And insert src when iframe intersects with viewport:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// react hooks fits perfect for extracting</span>\n<span class=\"token comment\">// such type (not only) of reusable logic</span>\n<span class=\"token keyword\">let</span> <span class=\"token function-variable function\">useLazyIframe</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n  <span class=\"token comment\">// we need to register our observer after our component mounted</span>\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> observer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IntersectionObserver</span><span class=\"token punctuation\">(</span>\n      <span class=\"token parameter\">entries</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        entries\n          <span class=\"token comment\">// filter only visible iframes</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> e<span class=\"token punctuation\">.</span>isIntersecting<span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> target<span class=\"token punctuation\">:</span> $el <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// iframe will start loading now</span>\n            $el<span class=\"token punctuation\">.</span><span class=\"token function\">setAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">'src'</span><span class=\"token punctuation\">,</span> $el<span class=\"token punctuation\">.</span><span class=\"token function\">getAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">'data-src'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token comment\">// no need to observe it anymore</span>\n            observer<span class=\"token punctuation\">.</span><span class=\"token function\">unobserve</span><span class=\"token punctuation\">(</span>$el<span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// we'll load iframe a bit beforehand</span>\n        rootMargin<span class=\"token punctuation\">:</span> <span class=\"token string\">'10%'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">)</span>\n\n    document\n      <span class=\"token punctuation\">.</span><span class=\"token function\">querySelectorAll</span><span class=\"token punctuation\">(</span><span class=\"token string\">'iframe[data-src]'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">$el</span> <span class=\"token operator\">=></span> observer<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>$el<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// do not forget to clean up on component unmount</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> observer<span class=\"token punctuation\">.</span><span class=\"token function\">disconnect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token comment\">/* we need to register observer once */</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>That's it!</p>\n<p><strong>Read more:</strong></p>\n<p><a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Intersection_Observer_API\">Intersection Observer API</a></p>\n<p><a href=\"https://developers.google.com/web/updates/2016/04/intersectionobserver\">IntersectionObserverâ€™s Coming into View</a></p>\n<p><a href=\"https://reactjs.org/docs/hooks-overview.html\">React hooks overview</a></p>"},"similarPosts":{"edges":[{"node":{"frontmatter":{"slug":"dynamics-in-a-static-site","title":"Dynamics in a static site","date":"2019-01-28T22:38:57.492Z","tags":["cloud-functions","gcp","github-api","reach-ui","reactjs","CORS","JAMStack"]},"timeToRead":4}},{"node":{"frontmatter":{"slug":"implementing-medium-like-tooltip","title":"Implementing medium like tooltip","date":"2019-01-20T21:52:08.746Z","tags":["reactjs","render-props","web-api"]},"timeToRead":4}},{"node":{"frontmatter":{"slug":"the-simplest-example-of-scheduling-on-the-main-thread","title":"The simplest example of scheduling on the main thread","date":"2019-02-19T22:42:04.602Z","tags":["web-api","algorithms","reactjs"]},"timeToRead":4}}]},"site":{"meta":{"siteUrl":"https://www.nikitakirsanov.com"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"id":"e7cf91c9-ffaa-57c9-8425-241aba5424c2","similarPosts":["dae1d080-147c-533f-86c6-0dd09a4e3b81","cc4f020a-6e32-59da-96f9-20e358676ac0","2c5e8ce3-f665-5c2a-b195-32e5596693e7"]}}}